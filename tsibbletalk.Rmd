---
title: "Conversations in time: interactive visualisation to explore structured temporal data"
author:
- name: Earo Wang
  affiliation: The University of Auckland
  address:
  - Department of Statistics
  - The Univerisity of Auckland
  - New Zealand
  email: earo.wang@auckland.ac.nz
- name: Dianne Cook
  affiliation: Monash University
  address:
  - Department of Econometrics and Business Statistics
  - Monash University
  - Australia
  email: dicook@monash.edu
bibliography: references.bib
abstract: >
  An abstract of less than 150 words.
preamble: |
  % Any extra LaTeX you need in the preamble
output: rticles::rjournal_article
---

```{r setup, echo = FALSE, cache = FALSE, include = FALSE}
options("knitr.graphics.auto_pdf" = TRUE)
library(knitr)
opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', fig.align = 'center', fig.show = 'hold',
  cache = TRUE, cache.path = 'cache/',
  out.width = ifelse(is_html_output(), "100%", "\\textwidth")
)
opts_knit$set(root.dir = here::here())
read_chunk("scripts/demo.R")
```

```{r, load-pkgs}
```

# Introduction

* An ensemble of graphics
* Accelerate the exploratory data visualization process

# Background and motivation

## Interactive visualisation systems with linking views

* {ggobi} and {xggobi}
* {cranvas} and {cranvastime}
* [crossfilter.js](http://crossfilter.github.io/crossfilter/) & [dc.js](https://dc-js.github.io/dc.js/)
* {crosstalk} and html widgets

## Tidy temporal data and workflow

The \CRANpkg{tsibble} package [@wang2020tsibble] introduces a unified temporal data structure, referred to as a `tsibble`, to represent time series and longitudinal data in a tidy format [@wickham2014tidy]. That said, a `tsibble` extends the `data.frame` and \CRANpkg{tibble} class with temporally contextual metadata: `index` and `key`. The `index` declares a data column that holds time-related indices. The `key` identifies a collection of related series or panels observed over the `index`-defined period, which can contain multiple columns. Below displays the monthly Australian retail trade turnover data (`aus_retail`), available in the \CRANpkg{tsibbledata} package. The `Month` column holds year-months as `index`. The `State` together with `Industry` are the identifiers for these 152 series, highlighted as `key`. Note that the column `Series ID` could be an alternative option for setting up `key`, but `State` and `Industry` are more readable and informative. The `index` and `key` are "sticky" columns to a `tsibble`, forming critical pieces for fluent temporal data analysis later.

```{r, print-retail}
```

In the spirit of tidy data to the \CRANpkg{tidyverse} [@Wickham2019], the **tidyverts** suite features `tsibble` as the foundational data structure, in order to build a fluid and fluent pipeline for time series analysis. Besides \CRANpkg{tsibble}, the \CRANpkg{feasts} and \CRANpkg{fable} packages fill the role of statistical analysis and forecasting in the **tidyverts** ecosystem. When time series analysis starts taking off, series of interest denoted by the `key` variables often remain unchanged over the course of analysis, from trend inspection to forecasting performance. Figure \ref{fig:highlight-retail} (a) gives an overview of 152 series for the retail data using an overlaid time series plot, while Figure \ref{fig:highlight-retail} (b) presents a scatterplot, where each series is represented by a dot in the feature space (trend versus seasonal strength). The plot making of Figure \ref{fig:highlight-retail} (b) is aided with the `features()` function from \CRANpkg{feasts}, which summarises original data by each series down to various statistical features. This function along with other **tidyverts** functions is `tsibble`-aware, and outputs a table in a reduced form where each row corresponds to a series, thus graphically displayed as Figure \ref{fig:highlight-retail} (b).

```{r highlight-retail, fig.height = 3.3, fig.cap = "ToDo"}
```

Figure \ref{fig:highlight-retail} highlights not only a series with strongest seasonality, but also a need to querying interesting series on the go. Without interactivity, one needs to first filter the interesting series out from the features table, and join back to the original `tsibble` in order to examine its trend in relation to others. This procedure can soon grow cumbersome if many series to be discovered. Despite that the two plots are static, they can be considered as linked views via the common `key` variables between two tables. This motivates enabling interactivity of `tsibble` and `tsibble`-derived objects for rapid exploratory data analysis.

# Shared temporal data for coordinated views

The \pkg{tsibbletalk} package, inspired by the \CRANpkg{crosstalk} package, introduces a shared tsibble data structure to enable reactivity for temporal data (i.e. a `tsibble`). The `as_shared_tsibble()` function turns a tsibble to a mutable tsibble `SharedTsibbleData`, as an R6 subclass of `SharedData` from {crosstalk}. A *tsibble* data object holds a set of interrelated series, identified by the "key", in a data frame. In the context of relational databases, the "key" acts like a foreign key in a reduced form of tsibble, while the index and key together operates like a primary key. (tsibble-centered workflow) When the "key" includes more than two variables, there can exist intrinsic structures in all combinations of variables: either nesting or crossing. (Add an example here)

The `spec` argument in the `as_shared_tsibble()` function takes a symbolic formula to allow users to specify structured combinations, using `/` and `*` adopted from Wilkinson notation (10.2307/2346786) for nesting and crossing expressions respectively. By default, the specification assumes crossing structure for all units.

Specifying the structure is particularly useful, when there's a hierarchical structure in the data. For such case, a new function `plotly_key_tree()` can help to visualise the "key" structure as a dendrogram, using plotly. This type of plot gives an overview of structured information in the data. Owing to its interactivity, each node in the tree plot is clickable and linked to other plots, and in turn the navigation at various levels is made easier.

When the key structure involves crossing only, one-to-one linking is the default.

* One-to-many linking: marking a single point of interest highlights all other points that share particular data values (categorical linking)
* Constructing recursive lists. Lists of key values, and json
* Self-linking: a single data source

# Slicing and dicing time

The other critical aspect of a tsibble is "index", that provides foundational temporal context. A common tool in time series analytical toolkit is seasonal plots that lay time series not on the whole time scale, but on an origin-less relative time unit, for example `gg_season()` in the {feasts} package. It helps to examine and emphasise periodic/aperiodic patterns, comparing to time series plots that primarily focus on trends. Standard seasonal plots break the overall time into two components: seasonal periods on the x-axis, and grouped by their corresponding lower-resolution time. For example, monthly data can be decomposed into months separated by years, and hourly data into hours grouped by days. Data collected at lower-level resolutions often exhibits more than one seasonal patterns. To discover typical seasonal or non-typical profiles, it is helpful to quickly browse through many possible periods. Interactivity ought to be enabled.

The {tsibbletalk} package provides a pair of UI and server functions, as a shiny module, to help with finding interesting time slices in a shiny application. The pair, decoupled to `tsibbleDiceUI()` and `tsibbleDiceServer()`, presents a clean interface and forms a resusable piece. Like all shiny modules, users should supply a unique session id. The UI function `tsibbleDiceUI()` shows a slider that controls the number of periods, and a plot specified by users. The server function `tsibbleDiceServer()` is the workhorse, transforming data and updating the plot. It expects a `ggplot` (converted to `plotly` via `ggplotly()`) or `plotly` object. This plot can be line charts, or other graphical elements (such as boxplots). But it assumes that tsibble's time index is plotted on the x-axis. The other mandatory argument is to specify the number of seasonal periods that requires shifting.

(Data flows) Transformed data generally requires redrawing the plot, and worsen the performance of shiny. The underlying tsibble data is called back and transformed in R. Using the `plotly.js` react method, only transformed data is sent to the server side, while keeping the rest configuration unchanged (e.g. layout and graphical elements). It is performant, and users will not experience notable delay in response to the change in the slider input. Dissect time index, and propagate transformed data to shiny server.

# Case study: monthly domestic tourist trips in Australia

# Conclusions and discussions

# References {-}
